<html>
	<head>
		<link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="components/angular-bootstrap-simple-chat/src/css/style.css">
	</head>
	<body ng-app='app'>
		<h3>Conversations</h3>

		<div ng-controller='ConvsCtrl' class='container'>
			<ul class='list-group'>
				<li ng-repeat='conv in convs' class='list-group-item'>
					<strong>@{{ conv.name }}</strong>
					<span>{{ conv.firstMessage }}</span>
					<button ng-click='joinConversation(conv.id)' class='btn btn-default'>Join</button>
				</li>
			</ul>
		</div>

		<h3>Chats</h3>
		<hr />
		

	  	<div ng-controller="ChatTabCtrl">
	  		<tabset vertical="true" type="pills">
			    <tab ng-repeat="(key, value) in chats" heading="{{chats[key].name}}">
			    	<div ng-controller="MsgCtrl">
			    		<ul class="list-group">
			    			<li ng-repeat="msg in chats[key].msgs" class="list-group-item">
			    				<strong>Person: </strong> <span>{{msg.msg}}</span>
			    			</li>
			    		</ul>
			    		<alert ng-repeat="alert in alerts" type="success" close="closeAlert($index)">{{alert.msg}}</alert>
				  		<input ng-model='msgToSend' class='form-control'/>
				  		<button ng-click='sendMessage()' class='btn btn-default'>Send</button>
			    	</div>
			    </tab>
			  </tabset>
	  	</div>


		<script src="components/socket.io-client/socket.io.js"></script>
		<script src="components/angularjs/angular.js"></script>
		<script src="components/angularjs-scroll-glue/src/scrollglue.js"></script>
		<script src="components/angular-socket-io/socket.js"></script>
		<script>
			var app = angular.module('app', ['btford.socket-io'
        	]).
        	factory('ioSocket', function(socketFactory){
            	return socketFactory();
        	}).
			factory('conversationService', function(){
				return { conversations: {} };
			}).
			controller('ConvsCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.convs = [];
				ioSocket.emit('add pharmacist');
				ioSocket.on('conversationCreated', function(conversation){

					addConversation(conversation);
				});

				$rootScope.$on('joinedConversation', function(conversationId){
					//some how remove the conversation from convs
				});

				function addConversation (conversation){
					
					$scope.convs.push({
						name: conversation.name,
						firstMessage: conversation.firstMessage,
						id: conversation.id
					});
					conversationService.conversations[conversation.id] = conversation;
				}

				$scope.joinConversation = function(conversationId){
					ioSocket.emit('joinConversation', conversationId, 'Pharmacist'); // name to come from session
				}
			}).
			controller('ChatTabCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.chats = [];
				$scope.msgs = {};
				

				ioSocket.on('joinedConversation', function(conversation){
					//TODO: remove conversation from the list
					$scope.chats.push({ name: conversation.name, id: conversation.id });
					//appendMessage(conversation.firstMessage);
					$scope.msgs[conversation.id] = {msg: conversation.firstMessage};
				});

			}).
			controller('MsgCtrl', function($scope, $rootScope, conversationService, ioSocket){

				$scope.sendMessage = function(){
					ioSocket.emit('chatMessage', $scope.msgToSend);
					//appendMessage($scope.msgToSend);
					msgToSend = null;
				}

				ioSocket.on('chatMessage', function(conversation, message){

					appendMessage(conversation.conversation, message);
				});



				function appendMessage(conversationId, message){
					$scope.msgs[conversationId] = {msg: message};
				}
				
			});
		</script>

	</body>
</html>