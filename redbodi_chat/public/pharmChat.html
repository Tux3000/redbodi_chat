<html>
	<head>
		<link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="css/map.css">
	</head>
	<body ng-app='app'>
		<h3>Queued Conversations</h3>

		<div ng-controller='ConvsCtrl' class='container'>
			<ul class='list-group'>
				<li ng-repeat='conv in convs' class='list-group-item'>
					<strong>@{{ conv.name }}</strong>
					<span>{{ conv.firstMessage }}</span>
					<button ng-click='joinConversation(conv.id)' class='btn btn-default'>Join</button>
				</li>
			</ul>
		</div>

		<h3>Chats</h3>
		<hr />
		

	  	<div ng-controller="ChatTabCtrl">
	  		<tabset vertical="true" type="pills">
			    <tab ng-repeat="(key, value) in chats" select="conversationSelected(key)" deselect="conversationDeselected(key)">
			    	<tab-heading>{{ value.messages[0].sender }} <span ng-if="value.unreadMessages > 0">{{ value.unreadMessages }}<i class="glyphicon glyphicon-bell"></i></span></tab-heading>
			    	<div ng-controller="MsgCtrl">
			    		<ul class="list-group">
			    			<li ng-repeat="chat in value.messages" class="list-group-item">
			    				<strong>{{ chat.sender }}: </strong> <span>{{ chat.msg }}</span>
			    			</li>
			    		</ul>
			    		<alert ng-repeat="alert in alerts" type="success" close="closeAlert($index)">{{ alert.msg }}</alert>
				  		<input ng-model='msgToSend' class='form-control'/>
				  		<button ng-click='sendMessage(key)' class='btn btn-default'>Send</button>
			    	</div>

				  	<h3>User Location</h3>
				  	<hr />
				  	<div ng-controller='LocCtrl'>
				  		<!--<div class="map_container">
				  			<google-map center="map.center" zoom="map.zoom" draggable="true" options="map.options" control="map.control">

				  				<markers models="map.markers" coords="'self'" options="'options'" isLabel='true'>
				  				</markers>

				  			</google-map>
				  		</div>-->

				  		<label>Location Status: </label><span>{{ statusMsg }}</span>
				  		<label>Latitude: </label><span>{{ latitude }}</span>
				  		<label>Longitude: </label><span>{{ longitude }}</span>
				  		<button ng-click='grabLocation(key)'>Grab User Location</button>

				  		<ui-gmap-google-map center='map.center' zoom='map.zoom'>
				  			<ui-gmap-markers models="map.markers" coords="'self'" icon="'icon'" options="'options'" isLabel='true'>
        					</ui-gmap-markers>
				  		</ui-gmap-google-map>
				  		<!--TODO: replace with google maps and a list of nearby pharmacies-->
			    	</div>

			    </tab>
			  </tabset>
	  	</div>


		<script src="http://maps.googleapis.com/maps/api/js?sensor=false&amp;language=en"></script>
		<script src="components/socket.io-client/socket.io.js"></script>
		<script src="components/angularjs/angular.js"></script>
		<script src="components/angularjs-scroll-glue/src/scrollglue.js"></script>
		<script src="components/angular-socket-io/socket.js"></script>
		<script src="components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
		<script src="components/lodash/dist/lodash.js"></script>
		<script src="components/angular-google-maps/dist/angular-google-maps.js"></script>
		<script>
			var app = angular.module('app', ['btford.socket-io', 'ui.bootstrap', 'uiGmapgoogle-maps'
        	]).
        	config(function(uiGmapGoogleMapApiProvider){
        		uiGmapGoogleMapApiProvider.configure({
        			key: '<api_key>',
        			v: '3.17'
        		});
        	}).
        	factory('ioSocket', function(socketFactory){
            	return socketFactory();
        	}).
			factory('conversationService', function(){
				return { conversations: {} };
			}).
			factory('MarkerCreatorService', function(){
				var markerId = 0;
				function create(latitude, longitude){
					var marker = {
						options: {
							animation: 0,
							labelAnchor: '28 -5',
							labelClass: 'markerlabel'
						},
						latitude: latitude,
						longitude: longitude,
						id: ++markerId,
						title: 'yo mama!'
					};
					marker.content = '<div class="infoWindowContent">test</div>';
					return marker;
				}

				function invokeSuccessCallback(successCallback, marker) {
			        if (typeof successCallback === 'function') {
			            successCallback(marker);
			        }
			    }

				function createByCoords(latitude, longitude, successCallback){
					var marker = create(latitude, longitude);
					invokeSuccessCallback(successCallback, marker);
				}

				return { createByCoords: createByCoords };
			}).
			controller('ConvsCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.convs = [];
				ioSocket.emit('pharmacistListener');
				ioSocket.on('conversationCreated', function(conversation){

					addConversation(conversation);
				});

				ioSocket.on('conversations', function(conversations){
					for (var i = 0; i< conversations.length; i++){
						addConversation(conversations[i]);
					}
				});

				$rootScope.$on('joinedConversation', function(eventName, conversationId){
					for( index = 0; index < $scope.convs.length; ++index){
						if($scope.convs[index].id === conversationId){
							removeConversation(index);
						}
					}
				});

				function removeConversation(index){
					$scope.convs.splice(index, 1);
				}

				function addConversation (conversation){
					
					$scope.convs.push({
						name: conversation.name,
						firstMessage: conversation.messages[0].msg,
						id: conversation.id
					});
					conversationService.conversations[conversation.id] = conversation;
				}

				$scope.joinConversation = function(conversationId){
					ioSocket.emit('joinConversation', conversationId, 'Pharmacist'); // name to come from session
				}
			}).
			controller('ChatTabCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.chats = {};
				
				

				ioSocket.on('joinedConversation', function(conversation){

					$scope.chats[conversation.id] = { chatSelected: ($scope.chats.length > 1 ? true : false), unreadMessages: 0, messages: [] };

					for(var i = 0; i < conversation.messages.length; i++){
                    	var chat = conversation.messages[i];
                    	$scope.appendMessage(conversation.id, chat.sender, chat.msg);
                	}

					$rootScope.$broadcast('joinedConversation', conversation.id);
				});

				ioSocket.on('chatMessage', function(conversation, message){
					
					$scope.appendMessage(conversation.conversation, conversation.name, message);
				});
				

				$scope.appendMessage = function(conversationId, sender, message){
					$scope.chats[conversationId].messages.push({msg: message, sender: sender});
					if(!$scope.chats[conversationId].chatSelected){
						$scope.chats[conversationId].unreadMessages+=1;
					}
				}

				$scope.conversationSelected = function(conversationId){
					$scope.chats[conversationId].unreadMessages = 0;
					$scope.chats[conversationId].chatSelected = true;
				}

				$scope.conversationDeselected = function(conversationId){
					$scope.chats[conversationId].chatSelected = false;
				}
			}).
			controller('MsgCtrl', function($scope, $rootScope, conversationService, ioSocket){

				$scope.sendMessage = function(convId){
					ioSocket.emit('chatMessage', convId, $scope.msgToSend);
					$scope.appendMessage(convId, "Pharmacist", $scope.msgToSend);
					$scope.msgToSend = null;
				}

			}).
			controller('LocCtrl', function($scope, $rootScope, ioSocket, MarkerCreatorService){
				$scope.latitude = 0;
				$scope.longitude = 0;
				$scope.statusMsg = 'N/A';

				$scope.grabLocation = function(conversationId){
					ioSocket.emit('getUserLocation', conversationId);					
				}

				ioSocket.on('userLocation', function(latitude, longitude, statusMsg){
					$scope.latitude = latitude;
					$scope.longitude = longitude;
					$scope.statusMsg = statusMsg;

					MarkerCreatorService.createByCoords(latitude, longitude, function(marker){
						marker.options.labelContent = 'user',
						$scope.userMarker = marker;
					});

					$scope.map = { 
						center:{ 
							latitude: latitude, 
							longitude: longitude 
						}, 
						zoom: 12,
						markers: []
					};
					$scope.map.markers.push($scope.userMarker);
				});

				//uiGmapGoogleMapApi.then(function(maps){

				//});
			});
		</script>	
	</body>
</html>







