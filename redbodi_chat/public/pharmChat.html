<html>
	<head>
		<link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
	</head>
	<body ng-app='app'>
		<h3>Queued Conversations</h3>

		<div ng-controller='ConvsCtrl' class='container'>
			<ul class='list-group'>
				<li ng-repeat='conv in convs' class='list-group-item'>
					<strong>@{{ conv.name }}</strong>
					<span>{{ conv.firstMessage }}</span>
					<button ng-click='joinConversation(conv.id)' class='btn btn-default'>Join</button>
				</li>
			</ul>
		</div>

		<h3>Chats</h3>
		<hr />
		

	  	<div ng-controller="ChatTabCtrl">
	  		<tabset vertical="true" type="pills">
			    <tab ng-repeat="(key, value) in chats" select="conversationSelected(key)" deslect="conversationDeslected(key)">
			    	<tab-heading>{{ value.messages[0].sender }} {{ value.unreadMessages }}</tab-heading>
			    	<div ng-controller="MsgCtrl">
			    		<ul class="list-group">
			    			<li ng-repeat="chat in value.messages" class="list-group-item">
			    				<strong>{{ chat.sender }}: </strong> <span>{{ chat.msg }}</span>
			    			</li>
			    		</ul>
			    		<alert ng-repeat="alert in alerts" type="success" close="closeAlert($index)">{{ alert.msg }}</alert>
				  		<input ng-model='msgToSend' class='form-control'/>
				  		<button ng-click='sendMessage(key)' class='btn btn-default'>Send</button>
			    	</div>

				  	<h3>User Location</h3>
				  	<hr />
				  	<div ng-controller='LocCtrl'>
				  		<label>Location Status: </label><span>{{ statusMsg }}</span>
				  		<label>Latitude: </label><span>{{ latitude }}</span>
				  		<label>Longitude: </label><span>{{ longitude }}</span>
				  		<button ng-click='grabLocation(key)'>Grab User Location</button>
				  		<!--TODO: replace with google maps and a list of nearby pharmacies-->
			    	</div>

			    </tab>
			  </tabset>
	  	</div>



		<script src="components/socket.io-client/socket.io.js"></script>
		<script src="components/angularjs/angular.js"></script>
		<script src="components/angularjs-scroll-glue/src/scrollglue.js"></script>
		<script src="components/angular-socket-io/socket.js"></script>
		<script src="components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
		<script>
			var app = angular.module('app', ['btford.socket-io', 'ui.bootstrap'
        	]).
        	factory('ioSocket', function(socketFactory){
            	return socketFactory();
        	}).
			factory('conversationService', function(){
				return { conversations: {} };
			}).
			controller('ConvsCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.convs = [];
				ioSocket.emit('pharmacistListener');
				ioSocket.on('conversationCreated', function(conversation){

					addConversation(conversation);
				});

				ioSocket.on('conversations', function(conversations){
					for (var i = 0; i< conversations.length; i++){
						addConversation(conversations[i]);
					}
				});

				$rootScope.$on('joinedConversation', function(eventName, conversationId){
					for( index = 0; index < $scope.convs.length; ++index){
						if($scope.convs[index].id === conversationId){
							removeConversation(index);
						}
					}
				});

				function removeConversation(index){
					$scope.convs.splice(index, 1);
				}

				function addConversation (conversation){
					
					$scope.convs.push({
						name: conversation.name,
						firstMessage: conversation.messages[0].msg,
						id: conversation.id
					});
					conversationService.conversations[conversation.id] = conversation;
				}

				$scope.joinConversation = function(conversationId){
					ioSocket.emit('joinConversation', conversationId, 'Pharmacist'); // name to come from session
				}
			}).
			controller('ChatTabCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.chats = {};
				
				

				ioSocket.on('joinedConversation', function(conversation){

					$scope.chats[conversation.id] = { chatSelected: true, unreadMessages: 0, messages: [] };

					for(var i = 0; i < conversation.messages.length; i++){
                    	var chat = conversation.messages[i];
                    	$scope.appendMessage(conversation.id, chat.sender, chat.msg);
                	}

					$rootScope.$broadcast('joinedConversation', conversation.id);
				});

				ioSocket.on('chatMessage', function(conversation, message){
					
					$scope.appendMessage(conversation.conversation, conversation.name, message);
				});
				

				$scope.appendMessage = function(conversationId, sender, message){
					$scope.chats[conversationId].messages.push({msg: message, sender: sender});
					if(!$scope.chats[conversationId].chatSelected){
						$scope.chats[conversationId].unreadMessages+=1;
					}
				}

				$scope.conversationSelected = function(conversationId){
					$scope.chats[conversationId].unreadMessages = 0;
					$scope.chats[conversationId].chatSelected = true;
				}

				$scope.conversationDeslected = function(conversationId){
					$scope.chats[conversationId].chatSelected = false;
					alert('deslected');
				}
			}).
			controller('MsgCtrl', function($scope, $rootScope, conversationService, ioSocket){

				$scope.sendMessage = function(convId){
					ioSocket.emit('chatMessage', convId, $scope.msgToSend);
					$scope.appendMessage(convId, "Pharmacist", $scope.msgToSend);
					$scope.msgToSend = null;
				}

			}).
			controller('LocCtrl', function($scope, $rootScope, ioSocket){
				$scope.latitude = 0;
				$scope.longitude = 0;
				$scope.statusMsg = 'N/A';

				$scope.grabLocation = function(conversationId){
					ioSocket.emit('getUserLocation', conversationId);					
				}

				ioSocket.on('userLocation', function(latitude, longitude, statusMsg){
					$scope.latitude = latitude;
					$scope.longitude = longitude;
					$scope.statusMsg = statusMsg;
				});
			});
		</script>
	</body>
</html>







