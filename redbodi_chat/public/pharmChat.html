<html>
	<head>
		<link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
	</head>
	<body ng-app='app'>
		<h3>Queued Conversations</h3>

		<div ng-controller='ConvsCtrl' class='container'>
			<ul class='list-group'>
				<li ng-repeat='conv in convs' class='list-group-item'>
					<strong>@{{ conv.name }}</strong>
					<span>{{ conv.firstMessage }}</span>
					<button ng-click='joinConversation(conv.id)' class='btn btn-default'>Join</button>
				</li>
			</ul>
		</div>

		<h3>Chats</h3>
		<hr />
		

	  	<div ng-controller="ChatTabCtrl">
	  		<tabset vertical="true" type="pills">
			    <tab ng-repeat="(key, value) in chats" heading="test">
			    	<div ng-controller="MsgCtrl">
			    		<ul class="list-group">
			    			<li ng-repeat="chat in value" class="list-group-item">
			    				<strong>{{ chat.sender }}: </strong> <span>{{ chat.msg }}</span>
			    			</li>
			    		</ul>
			    		<alert ng-repeat="alert in alerts" type="success" close="closeAlert($index)">{{alert.msg}}</alert>
				  		<input ng-model='msgToSend' class='form-control'/>
				  		<button ng-click='sendMessage(key)' class='btn btn-default'>Send</button>
			    	</div>
			    </tab>
			  </tabset>
	  	</div>


		<script src="components/socket.io-client/socket.io.js"></script>
		<script src="components/angularjs/angular.js"></script>
		<script src="components/angularjs-scroll-glue/src/scrollglue.js"></script>
		<script src="components/angular-socket-io/socket.js"></script>
		<script src="components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
		<script>
			var app = angular.module('app', ['btford.socket-io', 'ui.bootstrap'
        	]).
        	factory('ioSocket', function(socketFactory){
            	return socketFactory();
        	}).
			factory('conversationService', function(){
				return { conversations: {} };
			}).
			controller('ConvsCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.convs = [];
				ioSocket.emit('add pharmacist');
				ioSocket.on('conversationCreated', function(conversation){

					addConversation(conversation);
				});

				$rootScope.$on('joinedConversation', function(eventName, conversationId){
					//some how remove the conversation from convs
					for( index = 0; index < $scope.convs.length; ++index){
						if($scope.convs[index].id === conversationId){
							removeConversation(index);
						}
					}
				});

				function removeConversation(index){
					$scope.convs.splice(index, 1);
				}

				function addConversation (conversation){
					
					$scope.convs.push({
						name: conversation.name,
						firstMessage: conversation.firstMessage,
						id: conversation.id
					});
					conversationService.conversations[conversation.id] = conversation;
				}

				$scope.joinConversation = function(conversationId){
					ioSocket.emit('joinConversation', conversationId, 'Pharmacist'); // name to come from session
				}
			}).
			controller('ChatTabCtrl', function($scope, $rootScope, conversationService, ioSocket){
				$scope.chats = {};
				
				

				ioSocket.on('joinedConversation', function(conversation){
					$scope.chats[conversation.id] = [];
					$scope.appendMessage(conversation.id, conversation.firstMessage, conversation.name);
					$rootScope.$broadcast('joinedConversation', conversation.id);
				});

				$scope.appendMessage = function(conversationId, message, sender){
					$scope.chats[conversationId].push({msg: message, sender: sender});
				}
			}).
			controller('MsgCtrl', function($scope, $rootScope, conversationService, ioSocket){

				$scope.sendMessage = function(convId){
					ioSocket.emit('chatMessage', $scope.msgToSend);
					$scope.appendMessage(convId, $scope.msgToSend, "Pharmacist");
					$scope.msgToSend = null;
				}

				ioSocket.on('chatMessage', function(conversation, message){

					$scope.appendMessage(conversation.conversation, message, conversation.name);
				});
			});
		</script>

	</body>
</html>