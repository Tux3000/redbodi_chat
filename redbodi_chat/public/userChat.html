<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
  </head>
  <body ng-app='app'>
    <div ng-controller ='ChatSignupCtrl'>
        <div ng-controller='MsgCtrl' class='container' ng-hide='showSignup'>
            <h1>Messages</h1>
            <ul class='list-group'>
                <li ng-repeat='msg in msgs' class='list-group-item'>
                    <strong>{{ msg.sender }}: </strong> <span>{{ msg.msg }}</span>
                </li>
            </ul>
            <alert ng-repeat="alert in alerts" type="success" close="closeAlert($index)">{{alert.msg}}</alert>
            <input ng-model='msgToSend' class='form-control'/>
            <button ng-click='sendMessage()' class='btn btn-default'>Send</button>
        </div>

        <div ng-controller='SignupCtrl' class='container' ng-show='showSignup'>
            <h1>Start Chat</h1>
            <label>Name: </label><input ng-model='name' class='form-control'/>
            <label>Message: </label><input ng-model='firstMessage' class='form-control'/>
            <button ng-click='startChat()' class='btn btn-default'>Send</button>
        </div>
    </div>
    <div ng-controller='LocCtrl'>
    </div>

    <script src="components/socket.io-client/socket.io.js"></script>
    <script src="components/angularjs/angular.js"></script>
    <script src="components/angularjs-scroll-glue/src/scrollglue.js"></script>
    <script src="components/angular-socket-io/socket.js"></script>
    <script src="components/angular-bootstrap/ui-bootstrap-tpls.js"></script>

    <script>
       //var ioSocket =io();
       var app = angular.module('app', ['ui.bootstrap', 'btford.socket-io']).
        factory('ioSocket', function(socketFactory){
            return socketFactory();
        }).
        factory('userNameService', function(){
            return {username: null};
        }).
        controller('ChatSignupCtrl', function($scope, $rootScope){
            $scope.showSignup = true;
            $rootScope.$on('startChat', function(eventName){
                $scope.showSignup = false;
            });
        }).
        controller('SignupCtrl', function($scope, $rootScope, ioSocket, userNameService){
            $scope.startChat = function(){
                if($scope.name && $scope.firstMessage){
                    ioSocket.emit('startChat', $scope.name, $scope.firstMessage);
                    userNameService.username = $scope.name;
                    $scope.name = null;
                    $scope.firstMessage = null;
                }
            }
        }).
        controller('LocCtrl', function($scope, $rootScope, ioSocket){

            $scope.getPosition = function(position){
                $scope.lat = position.coords.latitude;
                $scope.lon = position.coords.longitude;
                $scope.sendLocationToServer(position.coords.latitude, position.coords.longitude, 'Success');
            }

            $scope.determineError = function(error){
                var errorMsg = 'Unable to determine user location';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = "User denied the request for Geolocation."
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = "Location information is unavailable."
                        break;
                    case error.TIMEOUT:
                        errorMsg = "The request to get user location timed out."
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMsg = "An unknown error occurred."
                        break;
                }
                $scope.sendLocationToServer(null, null, errorMsg);
            }

            $scope.getLocation = function(){
                if(navigator.geolocation){
                    navigator.geolocation.getCurrentPosition($scope.getPosition, $scope.determineError);
                }else{
                    $scope.sendLocationToServer(null, null, "User's browser does not support geolocation");
                }
            }

            $scope.sendLocationToServer = function(lat, lon, message){
                ioSocket.emit('userLocation', lat, lon, message);
            }

            $rootScope.$on('startChat', function(eventName){
                $scope.getLocation();
            });

        })
        .controller('MsgCtrl', function($scope, $rootScope, ioSocket, userNameService){
            $scope.msgs = [];
            $scope.alerts = [];
            $scope.conversationId = null;

            $rootScope.$on('firstMessage', function(eventName, conversation){
                for(var i = 0; i < conversation.messages.length; i++){
                    var chat = conversation.messages[i];
                    appendMessage(chat.sender, chat.msg);
                }
            });

            $scope.sendMessage = function(){
                if($scope.msgToSend){
                    ioSocket.emit('chatMessage', $scope.conversationId, $scope.msgToSend);
                    appendMessage(userNameService.username, $scope.msgToSend);
                    $scope.msgToSend = null;
                }
            }

            $scope.closeAlert = function(index){
                $scope.alerts.splice(index, 1);
            };

            ioSocket.on('chatMessage', function(sender, message){
                appendMessage(sender.name, message);
            });

            ioSocket.on('update', function(status){
                $scope.alerts.push({type: 'success', msg: status});
            });

            ioSocket.on('chatStarted', function(hasStrarted, conversation){
                if(hasStrarted){
                    $scope.alerts.push({type: 'success', msg: 'Conversation created'});
                    $rootScope.$broadcast('startChat');
                    $rootScope.$broadcast('firstMessage',  conversation);
                    $scope.conversationId = conversation.id;
                }
            });

            function appendMessage(sender, message){
                $scope.msgs.push({
                    sender: sender,
                    msg: message
                });
            }
        });






    </script>
  </body>
</html>