<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/chat.css">
  </head>
  <body ng-app='app'>
    <div class="container">
        <div class="row" style="padding-top:40px;">
            <div ng-controller ='ChatSignupCtrl'class="col-md-8">
                
                <div ng-controller='MsgCtrl' class='panel panel-primary' ng-hide='showSignup'>
                    <div class="panel-heading">
                        <span class="glyphicon glyphicon-comment"></span> Chat
                        <div class="btn-group pull-right" dropdown>

                            <button type="button" class="btn btn-default btn-xs" dropdown-toggle>
                                <span class="glyphicon glyphicon-chevron-down"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#"><span class="glyphicon glyphicon-refresh">
                                </span>Refresh</a></li>
                                <li><a href="#"><span class="glyphicon glyphicon-ok-sign">
                                </span>Available</a></li>
                                <li><a href="#"><span class="glyphicon glyphicon-remove">
                                </span>Busy</a></li>
                                <li><a href="#"><span class="glyphicon glyphicon-time"></span>
                                    Away</a></li>
                                <li class="divider"></li>
                                <li><a href="#"><span class="glyphicon glyphicon-off"></span>
                                    Sign Out</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="panel-body">
                        <ul class="chat">
                            <li ng-repeat='msg in msgs' class="{{msg.msgOptions.pullSide}} clearfix"><span class="chat-img pull-{{msg.msgOptions.pullSide}}">
                                    <img src="http://placehold.it/50/{{msg.msgOptions.avatarColour}}/fff&text={{msg.msgOptions.avatar}}" alt="User Avatar" class="img-circle" />

                                </span>

                                <div class="chat-body clearfix">
                                    <div ng-if="msg.msgOptions.pullSide==='left'">
                                        <div class="header">
                                            <strong class=" primary-font"> {{ msg.sender }} </strong><small class="pull-right text-muted">
                                            <span class="glyphicon glyphicon-time"></span> n mins ago</small><!--TODO: time to come from model-->
                                        </div>
                                    </div>  
                                    <div ng-if="msg.msgOptions.pullSide==='right'">
                                        <div class="header">
                                            <small class=" text-muted">
                                            <span class="glyphicon glyphicon-time"></span> n mins ago</small><strong class="pull-right primary-font"> {{ msg.sender }} </strong><!--TODO: time to come from model-->
                                        </div>
                                    </div>  
                                    <p>
                                        {{ msg.msg }}
                                    </p>
                                </div>

                            </li>
                        </ul>
                    </div>
                    <!--<alert ng-repeat="alert in alerts" type="success" close="closeAlert($index)">{{alert.msg}}</alert>-->
                    <div class="panel-footer">
                        <div class="input-group">
                            <input ng-model='msgToSend' class='form-control input-sm' placeholder="Type your message here..."/>
                            <span class="input-group-btn">
                                <button ng-click='sendMessage()' class='btn btn-warning btn-sm' id="btn-chat">Send</button>
                            </span>
                        </div>
                    </div>


                </div>
                <div ng-controller='SignupCtrl' class='panel panel-primary' ng-show='showSignup'>
                    <div class="panel-heading">
                        <span>Start Chat</span>
                    </div>
                    <div class="panel-body">
                        <div class="input-group">
                            <input ng-model='name' class='form-control input-sm' placeholder="What is your name?" /><button type="button" tooltip="See? Now click away..."  tooltip-trigger="focus" tooltip-placement="right"><span class="glyphicon glyphicon-question-sign"></span></button>
                            <input ng-model='email' class='form-control input-sm' placeholder="What is your email address?"/>
                            <input ng-model='dob' class='form-control input-sm' placeholder="When were you born?"/>
                            <span>
                                <div ng-controller="TermsCtrl">
                                    <script type="text/ng-template" id="myModalContent.html">
                                        <div class="modal-header">
                                            <h3 class="modal-title">Terms and Conditions</h3>
                                        </div>
                                        <div class="modal-body">
                                            //these are the terms
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-primary" ng-click="agree()">Agree</button>
                                            <button class="btn btn-warning" ng-click="cancel()">Cancel</button>
                                        </div>
                                    </script>
                                    Agree to <a ng-click="openTerms()">Terms and Conditions</a> <input type="checkbox" ng-model="hasAgreed" />
                                    <a href="" ng-click="test()"></a>
                                </div>



                            </span>

                        </div>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <input ng-model='firstMessage' class='form-control input-sm' placeholder="Type your message here..."/>
                            <span class="input-group-btn">
                                <button ng-click='startChat()' class='btn btn-warning btn-sm' id="btn-signup">Send</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div ng-controller='LocCtrl'>
    </div>

    <script src="components/socket.io-client/socket.io.js"></script>
    <script src="components/angularjs/angular.js"></script>
    <script src="components/angularjs-scroll-glue/src/scrollglue.js"></script>
    <script src="components/angular-socket-io/socket.js"></script>
    <script src="components/angular-bootstrap/ui-bootstrap-tpls.js"></script>

    <script>
       //var ioSocket =io();
       var app = angular.module('app', ['ui.bootstrap', 'btford.socket-io']).
        factory('ioSocket', function(socketFactory){
            return socketFactory();
        }).
        factory('userNameService', function(){
            return {username: null};
        }).
        controller('ChatSignupCtrl', function($scope, $rootScope){
            $scope.showSignup = true;
            $rootScope.$on('startChat', function(eventName){
                $scope.showSignup = false;
            });
        }).
        controller('SignupCtrl', function($scope, $rootScope, ioSocket, userNameService){
            $scope.startChat = function(){
                if($scope.name && $scope.firstMessage){
                    ioSocket.emit('startChat', $scope.name, $scope.firstMessage);
                    userNameService.username = $scope.name;
                    $scope.name = null;
                    $scope.firstMessage = null;
                }
            }
        }).
        controller('LocCtrl', function($scope, $rootScope, ioSocket){

            $scope.getPosition = function(position){
                $scope.lat = position.coords.latitude;
                $scope.lon = position.coords.longitude;
                $scope.sendLocationToServer(position.coords.latitude, position.coords.longitude, 'Success');
            }

            $scope.determineError = function(error){
                var errorMsg = 'Unable to determine user location';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = "User denied the request for Geolocation."
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = "Location information is unavailable."
                        break;
                    case error.TIMEOUT:
                        errorMsg = "The request to get user location timed out."
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMsg = "An unknown error occurred."
                        break;
                }
                $scope.sendLocationToServer(null, null, errorMsg);
            }

            $scope.getLocation = function(){
                if(navigator.geolocation){
                    navigator.geolocation.getCurrentPosition($scope.getPosition, $scope.determineError);
                }else{
                    $scope.sendLocationToServer(null, null, "User's browser does not support geolocation");
                }
            }

            $scope.sendLocationToServer = function(lat, lon, message){
                ioSocket.emit('userLocation', lat, lon, message);
            }

            $rootScope.$on('startChat', function(eventName){
                $scope.getLocation();
            });

        })
        .controller('MsgCtrl', function($scope, $rootScope, ioSocket, userNameService){
            $scope.msgs = [];
            $scope.alerts = [];
            $scope.conversationId = null;

            $rootScope.$on('firstMessage', function(eventName, conversation){
                for(var i = 0; i < conversation.messages.length; i++){
                    var chat = conversation.messages[i];
                    appendMessage(chat.sender, chat.msg);
                }
            });

            $scope.sendMessage = function(){
                if($scope.msgToSend){
                    ioSocket.emit('chatMessage', $scope.conversationId, $scope.msgToSend);
                    appendMessage(userNameService.username, $scope.msgToSend);
                    $scope.msgToSend = null;
                }
            }

            $scope.closeAlert = function(index){
                $scope.alerts.splice(index, 1);
            };

            ioSocket.on('chatMessage', function(sender, message){
                appendMessage(sender.name, message);
            });

            ioSocket.on('update', function(status){
                $scope.alerts.push({type: 'success', msg: status});
            });

            ioSocket.on('chatStarted', function(hasStrarted, conversation){
                if(hasStrarted){
                    $scope.alerts.push({type: 'success', msg: 'Conversation created'});
                    $rootScope.$broadcast('startChat');
                    $rootScope.$broadcast('firstMessage',  conversation);
                    $scope.conversationId = conversation.id;
                }
            });

            function appendMessage(sender, message){
                var msgOptions = {
                    pullSide: 'left',
                    oppositeSide: 'right',
                    avatar: 'P',
                    avatarColour: 'FA6F57'
                }; 

                if(userNameService.username === sender){
                    msgOptions.pullSide = 'right';
                    msgOptions.oppositeSide = 'left';
                    msgOptions.avatar = 'U';
                    msgOptions.avatarColour = '55C1E7';
                }

                $scope.msgs.push({
                    sender: sender,
                    msg: message,
                    msgOptions: msgOptions
                });
            }
        }).controller('TermsCtrl', function($scope, $modal){
            $scope.hasAgreed = false;

            $scope.openTerms = function(){
                var modalInstance = $modal.open({
                    templateUrl: 'myModalContent.html',
                    controller: 'ModalInstanceCtrl',
                    resolve:{
                        items: function(){
                            return $scope.hasAgreed
                        }
                    }
                });

                modalInstance.result.then(function(hasAgreed){
                    $scope.hasAgreed = hasAgreed;
                },function(){
                    $scope.hasAgreed = false;
                });
            };
        }).controller('ModalInstanceCtrl', function($scope, $modalInstance){
            $scope.agreed = false;

            $scope.agree = function(){
                $scope.agreed = true;
                $modalInstance.close($scope.agreed);
            };

            $scope.cancel = function(){
                $modalInstance.dismiss('cancel');
            };

        });






    </script>
  </body>
</html>